<html>
  <head>
    <title>Rolling gallery</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }

      .content {
        height: 100%;
      }

      h1 {
        font-size: 100pt;
        text-align: center;
        line-height: normal
      }

      img {
        object-fit: cover;
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="content"></div>
    <script type="text/javascript">
      class Maybe {
        constructor(x) {
          this.__value = x
        }

        static of(value) {
          return new this(value)
        }

        isNothing() {
          return this.__value === null || typeof this.__value === 'undefined'
        }

        map(f) {
          return this.isNothing() ? new Maybe(null) : new Maybe(f(this.__value))
        }

        getOrElse(defaultValue) {
          return this.isNothing() ? defaultValue : this.__value
        }
      }

      const getParameter = queryString => name =>
        Maybe.of(queryString)
          .map(params => params.split(`${name}=`))
          .map(([_, rest]) => rest)
          .map(rest => rest.split('&'))
          .map(([value, _]) => value)

      const initContent = element => {
        const content = document.querySelector('.content')
        content.innerHTML = ''
        content.appendChild(element)
      }

      const toDomNode = html => {
        const el = document.createElement('template')
        el.innerHTML = html
        return document.importNode(el.content, true)
      }

      const createTextElement = text =>
        toDomNode(`<h1>${text}</h1>`)

      const createImageElement = src =>
        toDomNode(`<img src="${src}"/>`)

      const showImagesFromPage = gallery => pageNumber => () =>
        window.fetch(`https://api.imgur.com/3/gallery/r/${gallery}/time/${pageNumber}`, {
          headers: {
            'Authorization': 'Client-ID 1400c78269df7bc'
          }
        })
          .then(response => response.json())
          .then(responseBody => responseBody.data)
          .then(images => {
            const galleryPage = showImagesFromPage(gallery)
            if (images.length) doSlideShow(images, galleryPage(pageNumber + 1))
            else if (pageNumber !== 0) galleryPage(0)()
            else initContent(createTextElement('Nothing to show :('))
          })
          .catch(e => {
            console.log(e)
            initContent(createTextElement('Error!'))
          })

      const doSlideShow = (images, nextPage) =>
        images
          .map(toImageUrl)
          .reduce(toSlideShow, Promise.resolve())
          .then(nextPage)

      const toImageUrl = imageData => imageData.link.replace('http://', 'https://')
      const cleanUpImage = () => window.URL.revokeObjectURL(document.querySelector('img').src)

      const toSlideShow = (sequence, imageUrl) =>
        sequence
          .then(() => window.fetch(imageUrl))
          .then(response => response.blob())
          .then(window.URL.createObjectURL)
          .then(createImageElement)
          .then(initContent)
          .then(cleanUpImage)
          .then(pause)
          .catch(e => {
            console.log(e)
            return Promise.resolve()
          })

      const pause = () => new Promise(resolve => setTimeout(resolve, 3000))

      initContent(createTextElement('Loading...'))

      const gallery = getParameter(location.search)('r').getOrElse('brokengifs')
      showImagesFromPage(gallery)(0)()
    </script>
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
          }, i[r].l = 1 * new Date()
        a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]
        a.async = 1
        a.src = g
        m.parentNode.insertBefore(a, m)
      })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga')

      ga('create', 'UA-91801368-1', 'auto')
      ga('send', 'pageview')
    </script>
  </body>
</html>