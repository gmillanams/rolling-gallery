<html>
  <head>
    <title>Rolling gallery</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }

      body {
        overflow: hidden;
      }

      h1 {
        font-size: 100pt;
        text-align: center;
        line-height: normal;
        margin: 0;
      }

      img {
        object-fit: cover;
        height: 100%;
        width: 100%;
      }

      .main-container {
        overflow: hidden;
        width: 200%;
        height:100%;
        display: flex;
      }

      .content {
        transition: margin-left 0.5s ease-out;
        width: 50%;
        height: 100%;
      }

    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="content">
        <h1>Loading...</h1>
      </div>
    </div>
    <script async src="analytics.js"></script>
    <script src="maybe.js"></script>
    <script src="get-parameter.js"></script>

    <script type="text/javascript">
      const toDomNode = html => {
        const el = document.createElement('template')
        el.innerHTML = html
        return el.content.cloneNode(true)
      }

      const initContent = html => {
        const mainContainer = document.querySelector('.main-container')
        const newContent = toDomNode(`<div class="content">${html}</div>`)
        const addNewContent = () => mainContainer.appendChild(newContent)
        const replaceContent = previousContent => {
          addNewContent()
          previousContent.style.marginLeft = '-50%'
          previousContent.addEventListener('transitionend', previousContent.remove)
        }
        Maybe.of(document.querySelector('.content')).fold(addNewContent, replaceContent)
      }

      const createTextTag = text => `<h1>${text}</h1>`
      const createImageTag = src => `<img src="${src}"/>`

      const showImagesFromPage = gallery => pageNumber => () =>
        window.fetch(`https://api.imgur.com/3/gallery/r/${gallery}/time/${pageNumber}`, {
          headers: {
            'Authorization': 'Client-ID 1400c78269df7bc'
          }
        }).then(response => response.json())
          .then(responseBody => responseBody.data)
          .then(images => {
            const galleryPage = showImagesFromPage(gallery)
            if (images.length) doSlideShow(images, galleryPage(pageNumber + 1))
            else if (pageNumber !== 0) galleryPage(0)()
            else initContent(createTextTag('Nothing to show :('))
          })
          .catch(e => {
            console.log(e)
            initContent(createTextTag('Error!'))
          })

      const doSlideShow = (images, nextPage) =>
        images
          .map(toImageUrl)
          .reduce(toSlideShow, Promise.resolve())
          .then(nextPage)

      const toImageUrl = imageData => imageData.link.replace('http://', 'https://')
      const cleanUpImage = imageUrl => () => window.URL.revokeObjectURL(imageUrl)

      const toSlideShow = (sequence, imageUrl) =>
        sequence
          .then(() => window.fetch(imageUrl))
          .then(response => response.blob())
          .then(window.URL.createObjectURL)
          .then(imageUrl =>
            new Promise(resolve => resolve(createImageTag(imageUrl)))
              .then(initContent)
              .then(cleanUpImage(imageUrl)))
          .then(pause)
          .catch(e => {
            console.log(e)
            return Promise.resolve()
          })

      const pause = () => new Promise(resolve => setTimeout(resolve, 3000))

      showImagesFromPage(getParameter(location.search)('r')
        .fold(() => 'brokengifs',
              gallery => gallery))(0)()
    </script>
  </body>
</html>